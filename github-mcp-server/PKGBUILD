# Maintainer: AjayK <maintainer@example.com>

pkgname=github-mcp-server
pkgver=0.1.0
pkgrel=1
pkgdesc="GitHub MCP (Model Context Protocol) Server for seamless integration with GitHub APIs"
arch=('x86_64' 'aarch64')
url="https://github.com/github/github-mcp-server"
license=('MIT')
depends=('docker')
makedepends=('go' 'git')
optdepends=('vscode: For VS Code integration')
provides=("${pkgname}")
conflicts=("${pkgname}")
options=('!strip' '!emptydirs')
source=("${pkgname}::git+https://github.com/github/github-mcp-server.git")
sha256sums=('SKIP')

build() {
  cd "${pkgname}"
  export CGO_CPPFLAGS="${CPPFLAGS}"
  export CGO_CFLAGS="${CFLAGS}"
  export CGO_CXXFLAGS="${CXXFLAGS}"
  export CGO_LDFLAGS="${LDFLAGS}"
  export GOFLAGS="-buildmode=pie -trimpath -ldflags=-linkmode=external -mod=readonly -modcacherw"
  
  # Build from source
  cd cmd/github-mcp-server
  go build -o github-mcp-server
}

package() {
  cd "${pkgname}/cmd/github-mcp-server"
  
  # Install binary
  install -Dm755 github-mcp-server "${pkgdir}/usr/bin/github-mcp-server"
  
  # Documentation
  cd "${srcdir}/${pkgname}"
  install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
  install -Dm644 README.md "${pkgdir}/usr/share/doc/${pkgname}/README.md"
  
  # Create systemd service file
  mkdir -p "${pkgdir}/usr/lib/systemd/system"
  cat > "${pkgdir}/usr/lib/systemd/system/github-mcp-server.service" << "EOF"
[Unit]
Description=GitHub MCP Server
After=network.target

[Service]
Type=simple
ExecStart=/usr/bin/github-mcp-server stdio
Restart=on-failure
Environment=GITHUB_PERSONAL_ACCESS_TOKEN=%i

[Install]
WantedBy=multi-user.target
EOF

  # Create config directory
  mkdir -p "${pkgdir}/etc/github-mcp-server"
  
  # Create sample config file
  cat > "${pkgdir}/etc/github-mcp-server/config.json.example" << "EOF"
{
  "TOOL_ADD_ISSUE_COMMENT_DESCRIPTION": "Add a comment to an existing issue",
  "TOOL_CREATE_BRANCH_DESCRIPTION": "Create a new branch in a GitHub repository"
}
EOF
}